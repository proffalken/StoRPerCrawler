version: "3.7"

services:
  micro_ros_agent:
    image: microros/micro-ros-agent:kilted
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
    command: ["udp4","--port","8888","-v5"]
    ports:
      - "8888:8888/udp"
    networks:
      - microros-net
    restart: unless-stopped

  ros_echo:
    image: ros:kilted-ros-base
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
    command: [
      "bash","-lc",
      ". /opt/ros/kilted/setup.bash && \
        echo \"[Echo] Listening on /cmd_velâ€¦\" && \
        ros2 topic echo /rt/cmd_vel \
       "
    ]
    networks:
      - microros-net
    restart: unless-stopped

  digital_twin:
    build:
      context: ./sim
      dockerfile: Dockerfile
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - LIBGL_ALWAYS_INDIRECT=1
    volumes:
      - /tmp/runtime-root:/tmp/runtime-root
      - /tmp/.X11-unix:/tmp/.X11-unix
      - ./storper_sim:/root/ros2_ws/src/storper_sim
    working_dir: /root/ros2_ws
    command: >
      bash -c '
        mkdir -p /tmp/runtime-root && chmod 700 /tmp/runtime-root
        export AMENT_PREFIX_PATH=/root/ros2_ws/install:$AMENT_PREFIX_PATH
        source /opt/ros/kilted/setup.bash
        colcon build --symlink-install --merge-install
        source install/local_setup.bash
        ros2 launch storper_sim storper_world.launch.py
      '
      #
      #    command: >
      #      bash -c "
      #         while true; do sleep 300; done
      #      "
    networks:
      - microros-net
    restart: unless-stopped
    privileged: true

  rviz:
    build:
      context: ./sim
      dockerfile: Dockerfile
    container_name: rviz
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      - ./gazebo:/root/ros2_ws/src/storper_sim
      - ./rviz_data:/root/.rviz2
    working_dir: /root/ros2_ws
    command: >
      bash -lc "
        source /opt/ros/kilted/setup.bash &&
        colcon build --merge-install &&
        source install/setup.bash &&
        rviz2 -d install/storper_sim/share/storper_sim/config/storper.rviz
      "
    networks:
      - microros-net
    privileged: true
    depends_on:
      - digital_twin


networks:
  microros-net:
    driver: bridge
    driver_opts:
      # <-- this turns ON multicast on our bridge so RTPS discovery will work
      com.docker.network.bridge.enable_multicast: "true"
    ipam:
      driver: default
      config:
        - subnet: 172.25.0.0/16

